<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shaka player V1.15</title>
    <link rel="shortcut icon" href="https://dash.cloudflare.com/favicon-196x196.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/shaka-player/dist/shaka-player.ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/shaka-player/dist/controls.min.css" rel="stylesheet">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000
        }

        #player-container {
            position: absolute;
            top: 0;
            left: 0
        }

        #player-container,
        #video {
            width: 100%;
            height: 100%
        }

        .shaka-spinner svg {
            stroke: #fff
        }
    </style>
</head>

<body>

    <div id="player-container" data-shaka-player-container>
        <video autoplay playsinline data-shaka-player id="video"></video>
    </div>

    <script>
        let channels = [];
        let player;
        let key1 = null;
        let key2 = null;
        let streamUrl = "";

        async function fetchChannelData(slug) {
            const tokenRes = await fetch("/api/token");
            const { token } = await tokenRes.json();

            const res = await fetch(`/api/channel?id=${slug}`, {
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            return res.json();
        }
        
        function slugify(name) {
            return name.toLowerCase().replace(/\s+/g, '-');
        }

        function getChannelFromURL() {
            const params = new URLSearchParams(window.location.search);
            const chSlug = params.get("id");
            if (!chSlug) return null;
            return channels.find(ch => slugify(ch.name) === chSlug);
        }

        async function init(channel) {
            document.title = `${channel.name} - Free`;

            const video = document.getElementById("video");
            const ui = video.ui;
            const controls = ui.getControls();
            const player = controls.getPlayer();

            ui.configure({
                controlPanelElements: [
                    "play_pause", "mute", "volume", "spacer",
                    "time_and_duration", "quality", "fullscreen", "overflow_menu"
                ],
                seekBarColors: {
                    base: 'rgba(100, 100, 100, 0.6)',
                    buffered: 'rgba(200, 200, 200, 0.7)',
                    played: 'rgba(229, 9, 20, 1)'
                },
                qualityMarks: {
                    '720': 'HD',
                    '1080': 'FHD',
                    '1440': '2K',
                    '2160': '4K',
                    '4320': '8K',
                },
                enableKeyboardPlaybackControls: true
            });

            if (channel.license_key && channel.license_key.includes(":")) {
                const parts = channel.license_key.split(":");
                key1 = parts[0];
                key2 = parts[1];
            }

            const drmConfig = { clearKeys: { [key1]: key2 } };
            player.configure({ drm: drmConfig });

            // Expose for debugging
            window.player = player;
            window.ui = ui;

            // Error handling
            player.addEventListener("error", onPlayerErrorEvent);
            controls.addEventListener("error", onUIErrorEvent);

            let hdnea = "";
            try {
                const m3u = await fetch("https://raw.githubusercontent.com/AstroSmarty/JioStar/refs/heads/main/playlist.m3u").then(r => r.text());
                const match = m3u.match(/__hdnea__=[^"&\s]+/);
                if (match) hdnea = match[0];
            } catch (e) {
                console.error("M3U read error", e);
            }

            player.getNetworkingEngine().registerRequestFilter((type, request) => {
                request.headers['Referer'] = 'https://www.jiotv.com/';
                request.headers['User-Agent'] = "plaYtv/7.1.5";

                if (hdnea) {
                    request.headers['Cookie'] = hdnea;

                    if (
                        (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
                            type === shaka.net.NetworkingEngine.RequestType.SEGMENT) &&
                        !request.uris[0].includes("__hdnea__")
                    ) {
                        request.uris[0] += (request.uris[0].includes("?") ? "&" : "?") + hdnea;
                    }
                }
            });

            streamUrl = channel.url;

            try {
                await player.load(streamUrl);
                video.play();
                console.log("Stream loaded:", channel.name);
            } catch (err) {
                console.error("PLAYER ERROR:", err);
            }
        }

        function onPlayerErrorEvent(event) {
            onPlayerError(event.detail);
        }

        function onPlayerError(error) {
            console.error("Player Error - Code:", error.code, "Details:", error);
        }

        function onUIErrorEvent(event) {
            onPlayerError(event.detail);
        }

        function initFailed(error) {
            console.error("Unable to load the Shaka UI library!", error);
        }

        async function main() {
            const slug = new URLSearchParams(location.search).get("id");
            const channel = await fetchChannelData(slug);
            init(channel);
        }

        document.addEventListener("DOMContentLoaded", main);
        document.addEventListener("shaka-ui-load-failed", initFailed);    
    </script>

</body>

</html>